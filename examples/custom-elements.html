<html>
  <head>
    <title>Custom Elements</title>
    <link rel="stylesheet" href="/styles.css" />
    <script type="module" src="https://jspm.dev/es-module-shims"></script>
  </head>
  <body>
    <!-- Here's a simple Three.js scene. -->

    <three-game>
      <!-- Lights on! -->
      <three-ambient-light intensity="0.2"></three-ambient-light>
      <three-directional-light intensity="0.8" position="10, 10, 50"></three-directional-light>

      <!-- Define a template. It automatically becomes available as a new HTML tag. -->
      <three-template tag="rotating-cube">
        <three-mesh>
          <three-dodecahedron-buffer-geometry></three-dodecahedron-buffer-geometry>
          <three-mesh-standard-material color="red"></three-mesh-standard-material>
        </three-mesh>
      </three-template>

      <!-- A bunch of rotating cubes. They're really dodecahedrons, sorry! -->
      <rotating-cube
        position="+2, +2, 0"
        onupdate="dt => this.object.rotation.z += dt"
      ></rotating-cube>
      <rotating-cube
        position="+2, -2, 0"
        onupdate="dt => this.object.rotation.z -= dt"
      ></rotating-cube>
      <rotating-cube
        position="-2, -2, 0"
        onupdate="dt => this.object.rotation.z += dt"
      ></rotating-cube>
      <rotating-cube
        position="-2, +2, 0"
        onupdate="dt => this.object.rotation.z -= dt"
      ></rotating-cube>
    </three-game>

    <!-- Import dependencies via ESM. The future is now! -->
    <script type="module">
      importShim("/dist/index.esm.js")

      /*
      It would be easier to just customize HTMLTemplateElement here, but that would
      not work on Safari, so we gotta do some extra work instead.
      */
      class ThreeTemplate extends HTMLElement {
        constructor() {
          super()
          this.attachShadow({ mode: "open" })

          /* Steal the only child */
          const child = this.firstElementChild

          /* Clear our contents because we don't want to actually render them */
          this.innerHTML = ""

          /* Create a new HTML element. It's a crazy world out there. */
          const tag = this.getAttribute("tag")

          const klass = class extends HTMLElement {
            constructor() {
              super()
              this.child = child
            }

            connectedCallback() {
              /* Let's make a shadow DOM! */
              this.attachShadow({ mode: "open" })

              /* Copy the template over into our shadow DOM */
              const element = this.child.cloneNode(true)
              this.shadowRoot.appendChild(element)

              // /* Apply all extra attributes we have */
              for (const key of this.getAttributeNames()) {
                element.setAttribute(key, this.getAttribute(key))
              }
            }
          }

          customElements.define(tag, klass)
        }

        connectedCallback() {}
      }

      customElements.define("three-template", ThreeTemplate)
    </script>
    <script type="importmap-shim">
      {
        "imports": {
          "three": "https://jspm.dev/three",
          "three/": "https://jspm.dev/three/"
        }
      }
    </script>
  </body>
</html>
